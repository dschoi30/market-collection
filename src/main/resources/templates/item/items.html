<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="css">
    <style>
        .mgt-5 {
            margin-top: 5px;
        }
        .mgb-30 {
            margin-bottom: 30px;
        }
        .wd220 {
            width: 220px;
        }
        .thumbnail {
            width: 50px;
            height: 50px;
        }
        .recent-view {
            overflow: hidden;
            width: 120px;
            height: 100px;
            position: fixed;
            top: 20%;
            right: 3%;
            border: 1px solid #c1c3c5;
        }
        .review-count {
            color: #808080;
        }
    </style>
</th:block>
<th:block layout:fragment="script">
    <script th:inline="javascript">
        async function printItems(cursorItemId) {
            const result = await axios.get(`/main/${cursorItemId}`, {param: cursorItemId})

            return result.data;
        }
        function printMoreItems(cursorItemId) {
            console.log("ok" + cursorItemId);
            printItems(cursorItemId).then(
                data => {
                    console.log(data.values);
                    moreItems.innerHTML += (printList(data.values));
                }
            );
        }
        function printList(dtoList) {
            let str = '';

            if(dtoList && dtoList.length > 0) {

                for (const dto of dtoList) {
                    str += `<div class="col-3 margin">
                <div class="card mgb-30 wd220">
                    <input type="hidden" class="item-id" value="${dto.id}">
                    <a href="/items/${dto.id}" class="text-dark" style="text-decoration-line: none;">
                        <img src="${dto.repImageUrl}" class="card-img-top" th:alt="${dto.itemName}" style="width: 220px; height: 250px;">
                        <div class="card-body">
                            <h5 class="card-title">${dto.itemName}</h5>
                            <h5 class="card-title fw-bold">${dto.salePrice}원</h5>
                            <h6 class="card-title review-count">후기 ${dto.reviewCount}</h6>
                        </div>
                    </a>
                </div>
            </div>`
                }
            }
            return str;
        }
        const moreItems = document.querySelector('.more-items');

        printMoreItems("");

        $(window).scroll(function () {
            if ((Math.round(($(window).scrollTop() + $(window).height()) / 1)) + 1 === $(document).height()) {
                let itemId = $(".item-id").last().val();
                printMoreItems(itemId);
            }
        });
    </script>
</th:block>

<div layout:fragment="content" class="content">
    <div class="row more-items">
    </div>

    <div th:if="${recentItems.size() > 0}" class="recent-view">
        <div>최근 본 상품</div>
        <div id="carouselExample" class="carousel carousel-dark carousel-fade mgt-5">
            <div class="carousel-inner" th:each="recentItem, status: ${recentItems}">
                <div th:if="${status.index eq 0}">
                    <div class="carousel-item active text-center">
                        <a th:href="'/items/' + ${recentItem.id}" class="text-dark" style="text-decoration-line: none;">
                            <img th:src="${recentItem.imageUrl}" class="card-img-top thumbnail" th:alt="${recentItem.itemName}">
                        </a>
                    </div>
                </div>
                <div th:unless="${status.index eq 0}">
                    <div class="carousel-item text-center">
                        <a th:href="'/items/' + ${recentItem.id}" class="text-dark" style="text-decoration-line: none;">
                            <img th:src="${recentItem.imageUrl}" class="card-img-top thumbnail" th:alt="${recentItem.itemName}">
                        </a>
                    </div>
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</div>

</html>